# Документация схем работы агента и пайплайнов Open WebUI

Этот документ содержит подробное описание всех пайплайнов и схем работы AI агента в Open WebUI, включая описание потока данных, используемых промтов и обработки результатов.

## Оглавление

1. [Пайплайн генерации заголовка чата](#пайплайн-генерации-заголовка-чата)
2. [Пайплайн генерации тегов](#пайплайн-генерации-тегов)
3. [Пайплайн генерации follow-up вопросов](#пайплайн-генерации-follow-up-вопросов)
4. [Пайплайн генерации поисковых запросов](#пайплайн-генерации-поисковых-запросов)
5. [Пайплайн RAG (Retrieval-Augmented Generation)](#пайплайн-rag-retrieval-augmented-generation)
6. [Пайплайн веб-поиска](#пайплайн-веб-поиска)
7. [Пайплайн вызова инструментов](#пайплайн-вызова-инструментов)
8. [Пайплайн Code Interpreter](#пайплайн-code-interpreter)
9. [Пайплайн автодополнения](#пайплайн-автодополнения)
10. [Пайплайн MOA (Mixture of Agents)](#пайплайн-moa-mixture-of-agents)

---

## Пайплайн генерации заголовка чата

**Назначение:** Автоматически генерирует краткий заголовок (3-5 слов) с эмодзи для нового чата на основе первых сообщений.

**Файлы:**
- `/backend/open_webui/routers/tasks.py` - endpoint `generate_title()`
- `/backend/open_webui/utils/task.py` - функция `title_generation_template()`
- `/backend/open_webui/config.py` - `DEFAULT_TITLE_GENERATION_PROMPT_TEMPLATE`

**Конфигурация:**
- `ENABLE_TITLE_GENERATION` - включить/выключить функцию
- `TITLE_GENERATION_PROMPT_TEMPLATE` - кастомный шаблон промта
- `TASK_MODEL` / `TASK_MODEL_EXTERNAL` - модель для задач

### Схема работы

```
┌──────────────┐
│   Frontend   │
│  (New Chat)  │
└──────┬───────┘
       │
       │ POST /tasks/title/completions
       │ Body: { chat_id, user_message, messages }
       ▼
┌──────────────────────────────────────┐
│  generate_title() endpoint           │
│  /backend/open_webui/routers/tasks.py│
└──────┬───────────────────────────────┘
       │
       │ 1. Извлекает последнее сообщение пользователя
       │ 2. Получает историю чата (последние 2 сообщения)
       │
       ▼
┌──────────────────────────────────────┐
│  title_generation_template()         │
│  /backend/open_webui/utils/task.py   │
└──────┬───────────────────────────────┘
       │
       │ Заменяет переменные в промте:
       │ - {{MESSAGES:END:2}} → последние 2 сообщения
       │ - {{USER_NAME}} → имя пользователя
       │ - {{CURRENT_DATE}} → текущая дата
       │
       ▼
┌──────────────────────────────────────┐
│  Сформированный промт                │
│                                      │
│  ### Task:                           │
│  Generate a concise, 3-5 word title  │
│  with an emoji...                    │
│                                      │
│  ### Chat History:                   │
│  User: How does photosynthesis work? │
│  Assistant: Photosynthesis is...     │
└──────┬───────────────────────────────┘
       │
       │ Отправляется в generate_chat_completion()
       │
       ▼
┌──────────────────────────────────────┐
│  TASK_MODEL (легкая модель)          │
│  Например: llama3.2:3b               │
└──────┬───────────────────────────────┘
       │
       │ Генерирует JSON ответ
       │
       ▼
┌──────────────────────────────────────┐
│  Результат (JSON)                    │
│  {                                   │
│    "title": "🌱 Photosynthesis       │
│              Explained"              │
│  }                                   │
└──────┬───────────────────────────────┘
       │
       │ Парсинг JSON
       │
       ▼
┌──────────────────────────────────────┐
│  Обновление чата в БД                │
│  chat.title = "🌱 Photosynthesis..."│
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────┐
│   Frontend   │
│  (Отображает │
│   заголовок) │
└──────────────┘
```

### Поток данных

**Вход:**
- `chat_id` - ID чата
- `user_message` - последнее сообщение пользователя
- `messages` - история сообщений

**Промежуточные данные:**
- Последние 2 сообщения из истории
- Отформатированный промт с заменёнными переменными

**Выход:**
- JSON объект с полем `title`
- Пример: `{ "title": "🌱 Photosynthesis Explained" }`

**Используемый промт:** `DEFAULT_TITLE_GENERATION_PROMPT_TEMPLATE` (см. PROMPTS_DOCUMENTATION.md)

---
